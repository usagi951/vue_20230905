<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/mycss.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/all.min.css">

    <title>類別管理</title>
    <style>

    </style>
</head>

<body>
    <!--nav bar-->
    <section id="section10">
        <nav class="navbar navbar-expand-lg bg-body-tertiary  ">
            <div class="container-fluid">
                <a class="navbar-brand " href="onePage.html">首頁</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link  " aria-current="page" href="product_control.html">會員管理</a>
                        <li class="nav-item">

                        <li class="nav-item">
                            <a class="nav-link  " aria-current="page" href="product_control.html">產品管理</a>
                        <li class="nav-item">
                            <a class="nav-link text-primary " aria-current="page" href="productType.html">類別管理</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link  " aria-current="page" href="chart_gender.html">男女比例</a>
                        </li>
                    </ul>
                </div>
                <span>
                    <h2 id="login_message" class="text-info ms-1"></h2>
                </span>
        
                <span> <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#typeModal">
                    新增產品類別
                </button></span>
                <span><a class="btn btn-danger ms-3" id="logout" href="#">登出</a></span>
            </div>
        </nav>
               


        </div>
    </section>
    <section id="section20">
        <div class="container">
            <table class="table">
                <thead>
                    <tr>
                        <th>編號</th>
                        <th>類別成稱</th>
                        <th>狀態</th>
                        <th>建檔時間</th>
                    </tr>
                </thead>
                <tbody id="type">
                    <tr>
                        <td data-th="編號">1</td>
                        <td data-th="類別名稱">包包</td>
                        <td data-th="狀態">
                            <div class="mb-3 form-check form-switch form-check-inline">
                                <input type="checkbox" class="form-check-input" role="switch">
                                <label for="" class="form-check-label">啟用</label>
                            </div>
                        </td>
                        <td data-th="建檔時間">12:20</td>
                        <td>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                                data-bs-target="#typeModal">
                                修改
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

    </section>
    <!--
    <div class="container">

        <div class="row">
            <div class="col-md-10">


                <div class="mb-3">
                    <label for="pname" class="form-label">產品類別</label>
                    <input type="text" class="form-control " id="pname" name="pname" placeholder="">
                    <div class="valid-feedback">輸入正確</div>
                    <div class="invalid-feedback">輸入錯誤</div>
                </div>
                <div class="text-center">
                    <a href="#" class="btn btn-primary" id="ok_btn">新增</a>
                    <a href="#" class="btn btn-secondary">取消</a>
                </div>
            </div>
        </div>

    </div>
    -->


    <!-- 新增產品類別Modal -->
    <div class="modal fade" id="typeModal" tabindex="-1" aria-labelledby="typeModal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">新增產品類別</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="insert_type" class="form-label">產品類別</label>
                    <input type="text" class="form-control is-invalid" id="insert_type" name="insert_type">
                    <div class="valid-feedback">輸入正確</div>
                    <div class="invalid-feedback" id="type_error">請勿空白</div>
                    <label for="active" class="form-label">是否啟用</label>
                    <select name="active" id="active" class="form-select">
                        <option value="Y">是</option>
                        <option value="N">否</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="ok_btn">確定</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改產品類別Modal -->
    <div class="modal fade" id="typeModal_edit" tabindex="-1" aria-labelledby="typeModal_edit" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">修改產品類別</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="insert_type" class="form-label">產品類別</label>
                    <input type="hidden" class="form-control " id="edit_typeId" name="edit_typeId">
                    <input type="text" class="form-control " id="edit_type" name="edit_type">
                    <div class="valid-feedback">輸入正確</div>
                    <div class="invalid-feedback" id="edit_error">請勿空白</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="ok_btn_update">確定</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancel_btn_update">取消</button>
                </div>
            </div>
        </div>
    </div>



    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/jquery-3.7.0.min.js"></script>
    <script src="https://unpkg.com/counterup2@2.0.2/dist/index.js"></script>
    <script>
        $(function () {
            //確認cookie是否有uid
            if (getCookie('uid01') != "") {
                //傳至後端確認是否合法
         

                $.ajax({
                    type: "post",
                    url: "api/check_uid_api.php",
                    dataType: "json",
                    data: { uid: getCookie('uid01') },
                    success: showdata_check_uid,
                    error: function () {
                        alert("error-api/check_uid_api.php")
                    },

                });
            } else {
                alert("請先登入");
                location.href = "onePage.html";
            }
        })
        function showdata_check_uid(data){
            if(data.state){
                let typeList = [];
                $("#login_message").html('<i class="fa-solid fa-crown golden"></i>' + '歡迎' + data.data.Nickname);
            $.ajax({
                url: "api/type_control_r_api.php",
                type: "get",
                dataType: "json",
                async: false,
                success: function (data) {
                 

                    data.data.forEach(function (item) {
                        var active;
                        var state;
                        typeList.push(item.Type);
                        if (item.Active == "Y") {
                            active = "checked";
                            state="啟用";
                        }
                        else{
                            state="停用";
                        }
                        var str = '<tr><td data-th="編號">' + item.Id + '</td><td data-th="類別名稱">' + item.Type + '</td><td data-th="狀態"><div class="mb-3 form-check form-switch form-check-inline"><input type="checkbox" class="form-check-input" role="switch" id="switch" data-id="'+ item.Id +'"' + active + '><label for="" class="form-check-label">'+state+'</label></div></td><td data-th="建檔時間">'+item.Create_at+'</td><td><button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#typeModal_edit" data-id="' + item.Id + '" data-type="' + item.Type + '" id="edit_btn">修改</button></td></tr>';
                        $("#type").append(str);
                    });
               
              

                },
                error: function () {
                    alert("error-api/type_r_api.php");
                }
            })

            var flag_type = false;
            //$("#insert_type").bind("input propertychange", function () {
            $("#insert_type").bind("input propertychange", function () {
                //正則表達是/^\S*$/.test()  若無空白則true
                if ($(this).val()!="") {
                    if (/^\S*$/.test($(this).val())) {

                        $(this).removeClass('is-invalid');

                        if (typeList.includes($(this).val())) {
                            $("#type_error").text("已有該產品類別");
                            $(this).addClass('is-invalid');
                            $(this).removeClass('is-valid');
                            flag_type = false;
                        } else {

                            $(this).addClass('is-valid');
                            $(this).removeClass('is-invalid');
                            flag_type = true;
                        }
                    }
                    else {
                        $("#type_error").text("請勿空白");
                        $(this).addClass('is-invalid');
                        $(this).removeClass('is-valid');
                        flag_type = false;
                    }
                }else{
                    $("#type_error").text("請勿空白");
                        $(this).addClass('is-invalid');
                        $(this).removeClass('is-valid');
                        flag_type = false;
                }

            })
            $("#ok_btn").click(function () {
                if (flag_type) {
                    $.ajax({
                        type: "POST",
                        url: "api/type_create_api.php",
                        dataType: "json",
                        data: {
                            type: $("#insert_type").val(),
                            active: $("#active").val()
                        },
                        success: function (data) {
                            $("#typeModal").modal("hide");
                            location.href = "productType.html";
                        },
                        error: function () {
                            alert("error-api/type_create_api.php");
                        }
                    });
                }
                else {
                    alert("錯誤");
                }
            })
            var flag_type_edit=false;
            var original;
            $("#type #edit_btn").click(function () {
          
                original=$(this).data("type");
                $("#edit_type").val($(this).data("type"));
                $("#edit_typeId").val($(this).data("id"));
                $("#edit_type").bind("input propertychange", function () {
                    //正則表達是/^\S*$/.test()  若無空白則true
                    if ($("#edit_type").val() != "") {

                        if (/^\S*$/.test($("#edit_type").val())) {
                            $("#edit_type").removeClass('is-invalid');

                            if (typeList.includes($("#edit_type").val())) {
                                $("#edit_error").text("已有該產品類別");
                                $("#edit_type").addClass('is-invalid');
                                $("#edit_type").removeClass('is-valid');
                                flag_type_edit = false;

                               
                            } else {

                                $("#edit_type").addClass('is-valid');
                                $("#edit_type").removeClass('is-invalid');
                                flag_type_edit = true;
                      
                            }
                        } else {
                            $("#edit_error").text("請勿空白");
                            $("#edit_type").addClass('is-invalid');
                            $("#edit_type").removeClass('is-valid');
                            flag_type_edit = false;
                        }

                    }
                    else {
                        $("#edit_error").text("請勿空白");
                        $("#edit_type").addClass('is-invalid');
                        $("#edit_type").removeClass('is-valid');
                        flag_type_edit = false;
                    }
                })
            })
            $("#ok_btn_update").click(function(){
                if(original==$("#edit_type").val()){
                    alert("你沒變更資料啊!");
                }else{
                    $.ajax({
                        type: "POST",
                        url: "api/type_u_api.php",
                        dataType: "json",
                        data: {
                            id:$("#edit_typeId").val(),
                            type:$("#edit_type").val()
                        },
                        success: function(data){
                            alert(data.message);
                            $("#typeModal_edit").modal("hide");
                            location.href = "productType.html";
                        },
                        error: function () {
                            alert("error-api/type_u_api.php");
                        }
                    });
                }
                
            })
            $("#cancel_btn_update").click(function(){
                if(original!=$("#edit_type").val()){
                    location.href = "productType.html";
                }
             
            })
            $("#type #switch").click(function(){
                var active,type_id;
                if($(this).is(":checked")){
                    active="Y";
                    type_id=$(this).data("id");
                    $(this).next().text("啟用");
             
                }else{
                    active="N";
                    type_id=$(this).data("id");
                    $(this).next().text("停用");
                }
                $.ajax({
                        type:"POST",
                        url:"api/type_active_u_api.php",
                        dataType:"json",
                        data:{
                            id:type_id,
                            active:active,
                        },
                        success:function(data){
                            alert(data.message);
                        },
                        error:function(){
                            alert("error-api/type_active_u_api.php")
                        }
                    });
            })
            }
        }
        $("#logout").click(function () {
            alert("已登出");
            setCookie("uid01", " ", 7);
            location.href = "onePage.html";
        });


         //import w3
         function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            let expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }
        function getCookie(cname) {
            let name = cname + "=";
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    

    </script>
</body>

</html>